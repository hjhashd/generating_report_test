# 数据库架构设计说明书 (V2)

本文件定义了系统 V2 版本的数据库核心架构、模块划分及演进逻辑，旨在为开发人员与 AI 协作提供清晰的技术参考。

---

## 一、 基础架构模块 (组织与用户)

本模块负责建立系统的组织根基，支持层级化的权限管理与业务统计。

### 1. `sys_departments` (部门表)
*   **技术定位**：组织架构树状模型存储。
*   **核心逻辑**：采用 `parent_id` + `ancestors` 冗余路径设计。
*   **设计初衷**：支持部门层级排行榜与跨部门数据穿透统计。通过 `ancestors` 字段可实现高效的树形搜索（如：统计“某中心”下所有子部门的数据），避免频繁的递归查询。
*   **业务场景**：
    *   **组织树展示**：前端直接获取全量数据，利用 `parent_id` 渲染组织架构树。
    *   **穿透统计**：查询 `ancestors LIKE '1,100,%'` 即可获取 ID 为 100 的部门下所有子孙部门的成员数据，用于生成“研发中心月度积分榜”。

### 2. `users` (用户表 - 升级版)
*   **技术定位**：业务关联的核心用户实体。
*   **关键字段**：
    *   `real_name`：真实姓名，用于实名活动发奖及系统合规审计。
    *   `department_id`：关联部门 ID，实现用户在组织架构中的物理挂载。
    *   `shulingtong_sk`：预留的第三方知识库（数灵童）唯一标识，用于 AI 检索私有文档时的身份隔离。
*   **业务场景**：
    *   **权限隔离**：当用户请求生成报告时，系统读取 `shulingtong_sk`，确保 AI 仅能检索该用户有权访问的企业知识库文档。
    *   **实名榜单**：在积分排行榜中展示 `real_name` 而非 `username`，增强内部激励的感知度。

---

## 二、 核心业务模块 (AI Prompt 系统)

本模块集成了提示词的生命周期管理、版本溯源及分级存储。

### 3. `ai_prompts` (提示词主表)
*   **技术定位**：Prompt 核心元数据存储。
*   **关键特性**：
    *   **溯源机制**：通过 `origin_prompt_id`（原始祖先）与 `parent_prompt_id`（直接父版本）构建提示词进化树。
    *   **模型配置**：通过 `variables_json`（变量定义）与 `model_config_json`（模型参数）实现 Prompt 与模型调优参数的深度解耦。
    *   **热度引擎**：内置 `view/like/copy/apply` 计数器，为排行榜提供 O(1) 复杂度的读取性能。
*   **业务场景**：
    *   **版本分叉**：用户 A 基于用户 B 的“周报生成器 V1”修改了提示词，系统记录新 Prompt 的 `parent_id` 为 V1 的 ID。前端展示时可绘制“提示词进化树”，显示该 Prompt 的前世今生。
    *   **热度排行**：首页“热门 Prompt”栏目直接按 `apply_count` 倒序查询，无需实时聚合日志表，保障高并发下的接口响应速度。

### 4. `ai_prompt_directories` (目录表)
*   **技术定位**：虚拟文件系统层。
*   **设计逻辑**：通过 `owner_id` 实现多租户隔离。`owner_id` 为空代表系统级公共目录，有值则代表用户个人私藏目录。支持 `parent_id` 嵌套实现多级文件夹结构。
*   **业务场景**：
    *   **个人收藏夹**：用户在“我的收藏”中创建多级目录整理 Prompt，系统仅查询 `owner_id = 当前用户` 的目录树。
    *   **公共市场分类**：管理员在后台配置“行业/场景/角色”三级公共目录，`owner_id` 设为 0，所有用户可见但不可修改。

### 5. `ai_prompt_directory_rel` (目录关联表)
*   **技术定位**：Prompt 与目录的多对多关联中间表。
*   **设计初衷**：支持同一个 Prompt 实体在多个逻辑文件夹中复用（如：同时存在于“官方推荐”与“我的收藏”），无需冗余存储数据副本。
*   **业务场景**：
    *   **多维归档**：一个“Java代码审查” Prompt 可以同时出现在“公共目录-研发工具”和用户的“个人目录-常用工具”中，删除个人收藏不影响公共库数据。

### 6. `ai_prompt_tags` & `ai_prompt_tag_relation` (标签系统)
*   **技术定位**：非结构化分类系统。
*   **用途**：支持系统预设标签与用户自定义标签，增强搜索召回率与推荐精准度。
*   **业务场景**：
    *   **智能推荐**：用户点击了标签为“年终总结”的 Prompt，系统推荐关联度高的其他“职场写作”类标签 Prompt。

---

## 三、 生产力工具模块 (智能报告)

本模块负责支撑报告的异步生成、结构化存储与版本回溯。

### 7. `report_name` (报告主表 - 升级版)
*   **技术定位**：报告生成任务的控制中心。
*   **关键逻辑**：引入 `status` 状态机（0-草稿, 1-生成中, 2-已完成, 3-失败），支持长耗时 AI 生成任务的异步解耦。
*   **业务场景**：
    *   **异步生成**：用户提交“生成行业分析报告”请求后，后端创建记录并将状态置为 `1`（生成中），立即返回。前端轮询该状态，待变为 `2` 后显示“查看报告”按钮。
    *   **断点续传**：若任务失败状态变为 `3`，用户点击“重试”，后端可读取 `last_step` 字段从中断章节继续生成，节省 Token 消耗。

### 8. `report_chapter_content` (报告内容表)
*   **技术定位**：报告正文内容存储（Markdown/HTML）。
*   **设计初衷**：将大段文本内容从目录结构表中剥离。
    *   **性能优化**：避免大字段对目录树查询的性能干扰。
    *   **版本控制**：支持 `version` 字段，为未来的撤销、重做及历史版本对比提供数据底座。
*   **业务场景**：
    *   **极速加载**：用户打开报告列表时，仅查询 `report_name` 表，不加载 MB 级的内容数据，实现秒开。
    *   **历史回溯**：用户对某章节内容不满意进行了手动修改，系统保存新版本 `version=2`。用户后续可点击“查看历史”，对比 AI 生成版与人工修改版的差异。

---

## 四、 审计与图谱模块 (日志与关系)

本模块负责系统的行为追踪、风险风控及关联图谱构建。

### 9. `sys_operation_logs` (操作日志)
*   **技术定位**：系统审计追踪。
*   **数据特性**：通过生成列 `create_date` 优化按天维度的聚合统计，支持活跃度看板的实时计算。
*   **业务场景**：
    *   **日活统计**：Dashboard 每日凌晨扫描 `create_date = 昨日` 的去重 `user_id` 数，生成日活（DAU）报表。

### 10. `sys_entity_relations` (实体关系表)
*   **技术定位**：通用关系图谱引擎。
*   **应用场景**：记录 Report、Prompt、User 之间的动态关联（如：引用关系 `Report A -> CITED -> Prompt B`）。
*   **价值**：用于分析实体权重、识别作弊行为及构建业务知识图谱。
*   **业务场景**：
    *   **影响力分析**：查询 `target_id = Prompt_X AND relation_type = 'CITED'`，统计该 Prompt 被多少份报告引用，以此评定其“业务价值”并发放高额积分奖励。
    *   **作弊风控**：发现某用户短时间内频繁创建小号引用自己的 Prompt 刷分，通过图谱分析其关联 IP 或设备指纹（扩展字段），触发风控报警。

### 11. `ai_user_interactions` (轻量交互)
*   **技术定位**：用户行为唯一性约束表。
*   **约束逻辑**：通过 `(user_id, target_id, action_type)` 唯一索引，强制保证点赞、收藏等操作的幂等性。
*   **业务场景**：
    *   **防重复点赞**：用户快速点击两次“点赞”按钮，数据库唯一索引拦截第二次请求，防止计数器错误增加。

### 12. `ai_chat_history` (对话历史)
*   **技术定位**：模型交互全量快照。
*   **核心数据**：保留 `raw_query`（用户原始输入）与 `final_prompt`（最终推理指令），支持 Prompt 效果回溯与工程优化分析。
*   **业务场景**：
    *   **Prompt 优化**：运营人员分析 `final_prompt` 与 AI 回复质量的关联，发现某类指令导致模型幻觉，进而优化系统预设 Prompt 模板。

---

## 五、 激励模块 (积分系统)

本模块负责积分的精确计算、账户余额维护及防重复计分审计。

### 13. `activity_user_wallet` (用户钱包)
*   **技术定位**：用户账户余额表。
*   **用途**：存储 `total_points` 与 `current_points`，作为高频读取的账户快照。
*   **业务场景**：
    *   **权益兑换**：用户消耗积分兑换 GPT-4 使用额度时，直接扣减 `current_points` 并校验余额是否充足，无需实时计算历史流水。

### 14. `activity_point_records` (积分流水)
*   **技术定位**：积分变动明细与审计日志。
*   **防刷机制**：通过唯一索引 `uk_prevent_spam` 约束 `(user_id, event_type, source_id, related_id)`。
*   **业务逻辑**：从数据库底层确保“同一业务事件（如某报告引用某 Prompt）”在全生命周期内仅能触发一次计分。
*   **业务场景**：
    *   **任务结算**：用户完成“每日签到”任务，系统写入流水。若因网络波动客户端重试请求，数据库唯一索引抛出 `Duplicate Key` 异常，后端捕获并返回“今日已签到”，保障积分资产安全。

---

## 六、 迁移与升级指南

### 1. 增量迁移策略 (`generating_reports_test_migration_v2.sql`)
*   **幂等性设计**：脚本通过 `IF NOT EXISTS` 与 `information_schema` 动态检测，支持在生产环境多次重入执行。
*   **演进路径**：
    *   **结构扩充**：在不破坏存量数据的前提下，向 `users`、`report_name` 等核心表追加业务字段。
    *   **新表注入**：按依赖顺序依次创建 Prompt 系统、积分系统、关系图谱等新功能表。
    *   **规范化补全**：统一存量表的字段注释、时间默认值及索引优化。

### 2. 使用建议
*   **开发环境**：若为全新部署，建议优先使用 [generating_reports_test_v2.sql](file:///root/zzp/langextract-main/generate_report_test/docs/database/generating_reports_test_v2.sql) 初始化完整结构。
*   **升级环境**：若存在存量数据，必须执行 [generating_reports_test_migration_v2.sql](file:///root/zzp/langextract-main/generate_report_test/docs/database/generating_reports_test_migration_v2.sql) 进行平滑升级。
*   **数据一致性**：新功能开发前，请务必校验迁移脚本是否已在对应环境执行完毕，确保字段与索引对齐。
