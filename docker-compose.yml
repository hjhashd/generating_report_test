version: '3.8'

x-common-env: &common-env
  PORT: 34521
  PYTHONUNBUFFERED: 1
  TZ: Asia/Shanghai
  JWT_SECRET: ${JWT_SECRET}
  JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}

services:
  app-dev:
    build: .
    image: langextract-app:${TAG:-latest}
    container_name: langextract-app-dev
    profiles: ["dev"]
    volumes:
      - .:/app
    ports:
      - "34521:34521"
    command: uvicorn new_report:app --host 0.0.0.0 --port 34521 --reload
    environment:
      <<: *common-env
      ENV: development
      # === 数据库配置 (从 .env 读取) ===
      REPORT_DB_HOST: ${REPORT_DB_HOST}
      REPORT_DB_PORT: ${REPORT_DB_PORT}
      REPORT_DB_USER: ${REPORT_DB_USER}
      REPORT_DB_PASSWORD: ${REPORT_DB_PASSWORD}
      REPORT_DB_NAME: ${REPORT_DB_NAME}
      
      AGENT_DB_HOST: ${AGENT_DB_HOST}
      AGENT_DB_PORT: ${AGENT_DB_PORT}
      AGENT_DB_USER: ${AGENT_DB_USER}
      AGENT_DB_PASSWORD: ${AGENT_DB_PASSWORD}
      AGENT_DB_NAME: ${AGENT_DB_NAME}

      # === Redis 配置 ===
      REDIS_ENABLED: "${REDIS_ENABLED:-0}"
      REDIS_TASK_STATUS_ENABLED: "${REDIS_TASK_STATUS_ENABLED:-0}"
      REDIS_CHAT_SESSION_ENABLED: "${REDIS_CHAT_SESSION_ENABLED:-0}"
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      REDIS_DB: "0"
      REDIS_PREFIX: "langextract"
    networks:
      - app_network

  app-prod:
    build: .
    image: langextract-app:${TAG:-latest}
    container_name: langextract-app-prod
    profiles: ["prod"]
    command: sh -c "uvicorn new_report:app --host 0.0.0.0 --port 34521 > report.log 2>&1"
    volumes:
      - /root/zzp/langextract-main/generate_report/report:/app/report
      - /root/zzp/langextract-main/generate_report/inferrence:/app/inferrence
      - /root/zzp/langextract-main/generate_report/report_merge:/app/report_merge
      - /root/zzp/langextract-main/generate_report/editor_image:/app/editor_image
      - ./logs/prod_report.log:/app/report.log
    ports:
      - "12543:34521"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: always
    environment:
      <<: *common-env
      ENV: production
      # === 数据库配置 (生产环境) ===
      REPORT_DB_HOST: 192.168.3.10
      REPORT_DB_PORT: 3306
      REPORT_DB_USER: root
      REPORT_DB_PASSWORD: xinan@2024
      REPORT_DB_NAME: generating_reports
      
      AGENT_DB_HOST: 192.168.3.13
      AGENT_DB_PORT: 3306
      AGENT_DB_USER: root
      AGENT_DB_PASSWORD: xinan123456
      AGENT_DB_NAME: agent_report
      
      # === Redis 配置 ===
      REDIS_ENABLED: "0"
      REDIS_TASK_STATUS_ENABLED: "0"
      REDIS_CHAT_SESSION_ENABLED: "0"
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      REDIS_DB: "0"
      REDIS_PREFIX: "langextract"
    networks:
      - app_network

  redis:
    image: docker.m.daocloud.io/library/redis:7-alpine
    container_name: langextract-redis
    command:
      - sh
      - -c
      - |
        redis-server \
          --appendonly yes \
          --requirepass "${REDIS_PASSWORD}" \
          --save 900 1 \
          --save 300 10 \
          --save 60 10000
    volumes:
      - ./redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - app_network
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10

networks:
  app_network:
    driver: bridge
